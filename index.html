<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONSTER TCG - HUB PROFESIONAL</title>
    <style>
        :root {
            --primary: #2c7be5;
            --dark: #1a1a1a;
            --light: #f9f9f9;
            --accent: #ffd700;
            --danger: #dc3545;
            --success: #28a745;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: white;
            padding-bottom: 50px;
        }

        /* --- LOGIN --- */
        #auth-screen {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
        }

        .auth-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #333;
            background: #222;
            color: white;
        }

        button {
            cursor: pointer;
            border: none;
            transition: 0.3s;
            font-weight: bold;
        }

        .btn-main {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
        }

        /* --- APP STRUCTURE --- */
        .top-bar {
            background: #000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-menu {
            display: flex;
            justify-content: center;
            background: #1a1a1a;
            padding: 10px;
            gap: 15px;
            overflow-x: auto;
        }

        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            background: #333;
            white-space: nowrap;
        }

        .nav-item.active {
            background: var(--primary);
        }

        section {
            padding: 20px;
            display: none;
            max-width: 1200px;
            margin: auto;
        }

        section.active { display: block; }

        /* --- CATALOGO --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .monster-card {
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
            transition: transform 0.3s;
        }

        .monster-card:hover { transform: scale(1.05); }

        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #333;
        }

        .card-info { padding: 10px; text-align: center; }

        /* --- RANKING --- */
        .rank-table {
            width: 100%;
            background: #1e1e1e;
            border-radius: 10px;
            border-collapse: collapse;
        }

        .rank-table th, .rank-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        /* --- ADMIN --- */
        .admin-zone {
            border: 2px solid var(--danger);
            padding: 20px;
            border-radius: 15px;
            background: #2a1010;
        }

        .hidden { display: none !important; }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            padding: 12px 25px;
            border-radius: 30px;
            display: none;
            z-index: 2000;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--primary)">MONSTER TCG</h1>
            <div id="login-box">
                <input type="text" id="user" placeholder="Usuario">
                <input type="password" id="pass" placeholder="Contrase√±a">
                <button class="btn-main" onclick="Auth.handle('login')">Entrar</button>
                <p onclick="document.getElementById('login-box').classList.add('hidden'); document.getElementById('reg-box').classList.remove('hidden')">¬øNo tienes cuenta? Reg√≠strate</p>
            </div>
            <div id="reg-box" class="hidden">
                <input type="text" id="r-user" placeholder="Nuevo Usuario">
                <input type="password" id="r-pass" placeholder="Nueva Contrase√±a">
                <button class="btn-main" style="background:var(--success)" onclick="Auth.handle('register')">Crear Cuenta</button>
                <p onclick="document.getElementById('reg-box').classList.add('hidden'); document.getElementById('login-box').classList.remove('hidden')">Volver</p>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="top-bar">
            <div>üî• <span id="my-name">...</span></div>
            <div>‚≠ê Lvl <span id="my-lvl">1</span> | <span id="my-xp">0</span> XP</div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="UI.tab('inicio')">Inicio</div>
            <div class="nav-item" onclick="UI.tab('catalogo')">Cat√°logo</div>
            <div class="nav-item" onclick="UI.tab('ranking')">Ranking</div>
            <div class="nav-item" onclick="UI.tab('canje')">Canjear</div>
            <div id="admin-nav" class="nav-item hidden" onclick="UI.tab('admin')" style="color:red">Admin</div>
        </div>

        <section id="inicio" class="active">
            <h2>üì∞ Noticias de la Comunidad</h2>
            <div id="news-feed">Cargando noticias...</div>
        </section>

        <section id="catalogo">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h2>üÉè Cat√°logo de Cartas</h2>
                <input type="text" id="search-card" placeholder="Buscar carta..." onkeyup="Game.filterCards()" style="width:200px">
            </div>
            <div class="card-grid" id="card-list">
                </div>
        </section>

        <section id="ranking">
            <h2>üèÜ Top Jugadores Online</h2>
            <table class="rank-table">
                <thead>
                    <tr><th>Pos</th><th>Usuario</th><th>Nivel</th><th>XP</th></tr>
                </thead>
                <tbody id="rank-body"></tbody>
            </table>
        </section>

        <section id="canje">
            <h2>üéüÔ∏è Centro de Canje</h2>
            <div class="auth-card" style="margin:auto; background:#222">
                <input type="text" id="claim-code" placeholder="Introduce c√≥digo">
                <button class="btn-main" onclick="Game.redeem()">Canjear C√≥digo</button>
            </div>
        </section>

        <section id="admin">
            <div class="admin-zone">
                <h2>üõ†Ô∏è Panel de Control Maestro</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                    <div>
                        <h3>A√±adir Carta</h3>
                        <input id="new-card-name" placeholder="Nombre">
                        <input id="new-card-img" placeholder="URL Imagen">
                        <input id="new-card-type" placeholder="Tipo (Fuego, Agua...)">
                        <button class="btn-main" onclick="Admin.addCard()">Publicar Carta</button>
                    </div>
                    <div>
                        <h3>Crear C√≥digo XP</h3>
                        <input id="new-code" placeholder="C√≥digo (ej: MONSTER2026)">
                        <input id="new-val" type="number" placeholder="Valor XP">
                        <button class="btn-main" onclick="Admin.addCode()">Crear C√≥digo</button>
                    </div>
                </div>
                <hr style="margin:30px 0; border:1px solid #444">
                <h3>Publicar Noticia</h3>
                <input id="news-title" placeholder="T√≠tulo">
                <textarea id="news-text" style="width:100%; height:100px; background:#111; color:white; border-radius:10px; padding:10px" placeholder="Contenido..."></textarea>
                <button class="btn-main" onclick="Admin.addNews()">Enviar Noticia</button>
            </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // 1. CONFIGURACI√ìN (Tus datos de Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyArz-RACSX-XJYv_kRmx22WcGHjA2-hflA",
            authDomain: "comunidadcartas.firebaseapp.com",
            projectId: "comunidadcartas",
            storageBucket: "comunidadcartas.appspot.com",
            messagingSenderId: "645947206318",
            appId: "1:645947206318:web:07ca349989b8f70f435b3f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentUser = null;
        let myDocId = null;

        // 2. SISTEMA DE UI
        const UI = {
            toast: (text) => {
                const t = document.getElementById('toast');
                t.innerText = text; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },
            tab: (id) => {
                document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                event.target.classList.add('active');
            }
        };

        // 3. AUTENTICACI√ìN
        const Auth = {
            handle: async (type) => {
                const u = document.getElementById(type === 'login' ? 'user' : 'r-user').value.toLowerCase().trim();
                const p = document.getElementById(type === 'login' ? 'pass' : 'r-pass').value;

                if(!u || !p) return UI.toast("Rellena todos los campos");

                const usersRef = db.collection('users');
                const snap = await usersRef.where('user', '==', u).get();

                if(type === 'register') {
                    if(!snap.empty) return UI.toast("Este usuario ya existe");
                    const newUser = {
                        user: u, pass: p, xp: 0, lvl: 1, 
                        role: 'user', usedCodes: [], 
                        created: Date.now()
                    };
                    await usersRef.add(newUser);
                    UI.toast("¬°Cuenta creada! Ya puedes entrar.");
                    location.reload();
                } else {
                    if(snap.empty || snap.docs[0].data().pass !== p) return UI.toast("Datos incorrectos");
                    myDocId = snap.docs[0].id;
                    currentUser = snap.docs[0].data();
                    Auth.launch();
                }
            },
            launch: () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                if(currentUser.role === 'admin') document.getElementById('admin-nav').classList.remove('hidden');
                
                // Escuchar datos del usuario en tiempo real
                db.collection('users').doc(myDocId).onSnapshot(doc => {
                    const d = doc.data();
                    document.getElementById('my-name').innerText = d.user.toUpperCase();
                    document.getElementById('my-xp').innerText = d.xp;
                    document.getElementById('my-lvl').innerText = d.lvl;
                });

                Game.init();
            }
        };

        // 4. L√ìGICA DE JUEGO
        const Game = {
            init: () => {
                Game.loadCards();
                Game.loadRanking();
                Game.loadNews();
            },
            loadCards: () => {
                db.collection('cards').onSnapshot(snap => {
                    const list = document.getElementById('card-list');
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const c = doc.data();
                        list.innerHTML += `
                            <div class="monster-card" data-name="${c.name}">
                                <img src="${c.img}" class="card-img" onerror="this.src='https://via.placeholder.com/150'">
                                <div class="card-info">
                                    <h4 style="margin:5px 0">${c.name}</h4>
                                    <span style="font-size:12px; color:var(--primary)">${c.type}</span>
                                </div>
                            </div>
                        `;
                    });
                });
            },
            filterCards: () => {
                const q = document.getElementById('search-card').value.toLowerCase();
                document.querySelectorAll('.monster-card').forEach(c => {
                    c.style.display = c.dataset.name.toLowerCase().includes(q) ? 'block' : 'none';
                });
            },
            loadRanking: () => {
                db.collection('users').orderBy('xp', 'desc').limit(20).onSnapshot(snap => {
                    const body = document.getElementById('rank-body');
                    body.innerHTML = "";
                    let pos = 1;
                    snap.forEach(doc => {
                        const u = doc.data();
                        body.innerHTML += `
                            <tr>
                                <td>${pos === 1 ? 'ü•á' : pos}</td>
                                <td>${u.user} ${u.role === 'admin' ? 'üõ°Ô∏è' : ''}</td>
                                <td>${u.lvl}</td>
                                <td>${u.xp}</td>
                            </tr>
                        `;
                        pos++;
                    });
                });
            },
            loadNews: () => {
                db.collection('news').orderBy('date', 'desc').onSnapshot(snap => {
                    const feed = document.getElementById('news-feed');
                    feed.innerHTML = "";
                    snap.forEach(doc => {
                        const n = doc.data();
                        feed.innerHTML += `
                            <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:15px; border-left:4px solid var(--primary)">
                                <h3 style="margin:0">${n.title}</h3>
                                <p style="color:#aaa; font-size:14px">${n.body}</p>
                            </div>
                        `;
                    });
                });
            },
            redeem: async () => {
                const codeTxt = document.getElementById('claim-code').value.trim();
                if(!codeTxt) return;

                const codeSnap = await db.collection('codes').where('name', '==', codeTxt).get();
                if(codeSnap.empty) return UI.toast("C√≥digo inv√°lido");

                const codeData = codeSnap.docs[0].data();
                
                // Verificar si ya se us√≥ (localmente primero por velocidad)
                const userDoc = await db.collection('users').doc(myDocId).get();
                const userData = userDoc.data();

                if(userData.usedCodes && userData.usedCodes.includes(codeTxt)) {
                    return UI.toast("Ya canjeaste este c√≥digo antes");
                }

                const newXP = userData.xp + parseInt(codeData.val);
                const newLvl = Math.floor(newXP / 100) + 1;

                await db.collection('users').doc(myDocId).update({
                    xp: newXP,
                    lvl: newLvl,
                    usedCodes: firebase.firestore.FieldValue.arrayUnion(codeTxt)
                });

                UI.toast(`¬°√âxito! +${codeData.val} XP a√±adidos`);
                document.getElementById('claim-code').value = "";
            }
        };

        // 5. ADMINISTRACI√ìN
        const Admin = {
            addCard: async () => {
                const name = document.getElementById('new-card-name').value;
                const img = document.getElementById('new-card-img').value;
                const type = document.getElementById('new-card-type').value;
                await db.collection('cards').add({ name, img, type });
                UI.toast("Carta a√±adida al cat√°logo");
            },
            addCode: async () => {
                const name = document.getElementById('new-code').value;
                const val = document.getElementById('new-val').value;
                await db.collection('codes').add({ name, val });
                UI.toast("C√≥digo de regalo activo");
            },
            addNews: async () => {
                const title = document.getElementById('news-title').value;
                const body = document.getElementById('news-text').value;
                await db.collection('news').add({ title, body, date: Date.now() });
                UI.toast("Noticia publicada");
            }
        };
    </script>
</body>
</html>
