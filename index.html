<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONSTER TCG - Comunidad Online</title>
    <style>
        /* =========================================
           ESTILOS (Mismo dise√±o bonito)
           ========================================= */
        :root { --azul: #2c7be5; --fondo: #f4f6f8; --rojo: #dc3545; --dorado: #ffd700; --verde: #28a745; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--fondo); color: #333; padding-bottom: 80px; }
        
        /* LOGIN */
        .auth-container { max-width: 400px; margin: 60px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .form-group input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--azul); color: white; }
        .btn-primary:hover { background: #1a5fd0; }
        
        /* APP UI */
        .hidden { display: none !important; }
        .user-bar { background: #111; color: white; padding: 15px; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        
        header { background: linear-gradient(135deg, #222, #444); color: white; padding: 30px; text-align: center; }
        .nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .nav button { width: auto; background: rgba(255,255,255,0.2); color: white; }
        .nav button.active { background: var(--azul); }

        section { max-width: 900px; margin: 20px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none; }
        section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

        /* RANKING TABLE */
        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table th { text-align: left; background: #eee; padding: 10px; }
        .ranking-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .rank-1 { color: #b49b00; font-weight: bold; background: #fffde7; }
        
        /* ADMIN PANEL */
        .admin-box { border: 2px dashed var(--rojo); padding: 15px; background: #fff5f5; margin-top: 20px; border-radius: 8px; }
        
        /* NOTIFICACIONES */
        #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px; border-radius: 8px; display: none; z-index: 999; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="auth-screen" class="auth-container">
        <h1 style="color:var(--azul)">MONSTER TCG</h1>
        <p>Sistema Online v4.0</p>
        
        <div id="login-form">
            <input type="text" id="login-user" placeholder="Usuario">
            <input type="password" id="login-pass" placeholder="Contrase√±a">
            <button class="btn-primary" onclick="auth.login()">Entrar</button>
            <p onclick="ui.toggleAuth()" style="cursor:pointer; color:var(--azul); text-decoration:underline">Crear cuenta nueva</p>
        </div>

        <div id="reg-form" class="hidden">
            <input type="text" id="reg-user" placeholder="Nuevo Usuario">
            <input type="password" id="reg-pass" placeholder="Nueva Contrase√±a">
            <button class="btn-primary" style="background:var(--verde)" onclick="auth.register()">Registrarse</button>
            <p onclick="ui.toggleAuth()" style="cursor:pointer; color:#666">Volver al login</p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="user-bar">
            <div>üë§ <span id="my-user">...</span> <span id="my-lvl" style="background:var(--azul); padding:2px 8px; border-radius:10px; font-size:12px">Lvl 1</span></div>
            <div>‚≠ê <span id="my-xp">0</span> XP <button onclick="location.reload()" style="padding:2px 10px; font-size:12px; width:auto; background:var(--rojo); margin-left:10px">Salir</button></div>
        </div>

        <header>
            <h1>Comunidad TCG Online</h1>
            <div class="nav">
                <button onclick="ui.show('ranking')" class="active">üèÜ Ranking</button>
                <button onclick="ui.show('codigos')">üéüÔ∏è C√≥digos</button>
                <button onclick="ui.show('noticias')">üì∞ Noticias</button>
                <button onclick="ui.show('admin')" id="btn-admin" class="hidden" style="background:var(--rojo)">üõ†Ô∏è Admin</button>
            </div>
        </header>

        <section id="ranking" class="active">
            <h2>üèÜ Ranking en Tiempo Real</h2>
            <p>Compite con tus amigos. Se actualiza solo.</p>
            <table class="ranking-table">
                <thead><tr><th>#</th><th>Jugador</th><th>Nivel</th><th>XP</th></tr></thead>
                <tbody id="ranking-list"></tbody>
            </table>
        </section>

        <section id="codigos">
            <h2>üéüÔ∏è Canjear C√≥digo</h2>
            <div style="display:flex; gap:10px">
                <input id="code-input" placeholder="Escribe el c√≥digo aqu√≠">
                <button class="btn-primary" onclick="game.redeem()">Canjear</button>
            </div>
            <p id="code-msg" style="margin-top:10px; color:#666"></p>
        </section>

        <section id="noticias">
            <h2>üì∞ Noticias</h2>
            <div id="news-list">Cargando noticias...</div>
        </section>

        <section id="admin">
            <h2>üõ†Ô∏è Panel de Administrador</h2>
            <div class="admin-box">
                <h3>‚ûï Crear C√≥digo de XP</h3>
                <input id="new-code-name" placeholder="Ej: REGALO2026">
                <input id="new-code-val" type="number" placeholder="Cantidad XP (ej: 50)">
                <button class="btn-primary" onclick="admin.createCode()">Crear C√≥digo</button>
            </div>
            <div class="admin-box" style="border-color: #333; background: #eee;">
                <h3>üì∞ Publicar Noticia</h3>
                <input id="new-news-title" placeholder="T√≠tulo">
                <textarea id="new-news-body" style="width:100%; margin:10px 0" placeholder="Contenido"></textarea>
                <button class="btn-primary" onclick="admin.postNews()">Publicar</button>
            </div>
            <div class="admin-box">
                <h3>üëë Gesti√≥n de Staff</h3>
                <input id="new-admin-name" placeholder="Usuario para hacer Admin">
                <button class="btn-primary" style="background:var(--dorado); color:black" onclick="admin.makeAdmin()">Dar Permisos</button>
            </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // 1. CONFIGURACI√ìN FIREBASE (Usa la tuya o esta de prueba)
        const firebaseConfig = {
            apiKey: "AIzaSyArz-RACSX-XJYv_kRmx22WcGHjA2-hflA",
            authDomain: "comunidadcartas.firebaseapp.com",
            projectId: "comunidadcartas",
            storageBucket: "comunidadcartas.appspot.com",
            messagingSenderId: "645947206318",
            appId: "1:645947206318:web:07ca349989b8f70f435b3f"
        };
        
        // Inicializar
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Variables globales
        let currentUser = null;
        let myDocRef = null;

        // ================= SISTEMA DE UI =================
        const ui = {
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },
            toggleAuth: () => {
                document.getElementById('login-form').classList.toggle('hidden');
                document.getElementById('reg-form').classList.toggle('hidden');
            },
            show: (id) => {
                document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            }
        };

        // ================= AUTENTICACI√ìN =================
        const auth = {
            register: async () => {
                const u = document.getElementById('reg-user').value.trim();
                const p = document.getElementById('reg-pass').value.trim();
                if(!u || !p) return ui.toast("Faltan datos");

                // Verificar si existe en la Nube
                const snap = await db.collection('users').where('username', '==', u).get();
                if(!snap.empty) return ui.toast("Usuario ya existe");

                // Crear usuario en Nube
                await db.collection('users').add({
                    username: u, password: p, xp: 0, level: 1, role: 'user', 
                    redeemedCodes: [], lastLogin: null
                });
                
                ui.toast("¬°Cuenta creada! Inicia sesi√≥n.");
                ui.toggleAuth();
            },

            login: async () => {
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                
                // Buscar en la Nube
                const snap = await db.collection('users').where('username', '==', u).where('password', '==', p).get();
                
                if(snap.empty) return ui.toast("Usuario o contrase√±a incorrectos");

                // Guardar referencia al usuario actual
                const doc = snap.docs[0];
                currentUser = doc.data();
                myDocRef = db.collection('users').doc(doc.id);

                ui.toast("¬°Bienvenido " + currentUser.username + "!");
                app.start();
            }
        };

        // ================= L√ìGICA DEL JUEGO =================
        const app = {
            start: () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                // Si soy admin, mostrar panel
                if(currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                    document.getElementById('btn-admin').classList.remove('hidden');
                }

                // Escuchar mis propios cambios (para actualizar XP en barra)
                myDocRef.onSnapshot(doc => {
                    currentUser = doc.data();
                    document.getElementById('my-user').innerText = currentUser.username;
                    document.getElementById('my-xp').innerText = currentUser.xp;
                    document.getElementById('my-lvl').innerText = "Nvl " + currentUser.level;
                });

                // Cargar Ranking en Tiempo Real
                app.listenRanking();
                app.listenNews();
            },

            listenRanking: () => {
                // Esto escucha cambios en TODA la colecci√≥n de usuarios
                db.collection('users').orderBy('xp', 'desc').limit(50).onSnapshot(snap => {
                    const list = document.getElementById('ranking-list');
                    list.innerHTML = "";
                    let pos = 1;
                    snap.forEach(doc => {
                        const u = doc.data();
                        let rowClass = pos === 1 ? 'rank-1' : '';
                        let badge = u.role === 'admin' || u.role === 'superadmin' ? 'üõ°Ô∏è' : '';
                        
                        list.innerHTML += `
                            <tr class="${rowClass}">
                                <td>#${pos}</td>
                                <td>${u.username} ${badge}</td>
                                <td>${u.level}</td>
                                <td><b>${u.xp}</b></td>
                            </tr>
                        `;
                        pos++;
                    });
                });
            },

            listenNews: () => {
                db.collection('news').orderBy('date', 'desc').onSnapshot(snap => {
                    const div = document.getElementById('news-list');
                    div.innerHTML = "";
                    snap.forEach(doc => {
                        const n = doc.data();
                        div.innerHTML += `
                            <div style="border-bottom:1px solid #eee; padding:15px 0">
                                <h3 style="color:var(--azul); margin:0">${n.title}</h3>
                                <small>${new Date(n.date).toLocaleDateString()}</small>
                                <p>${n.body}</p>
                            </div>
                        `;
                    });
                });
            }
        };

        const game = {
            redeem: async () => {
                const codeTxt = document.getElementById('code-input').value.trim();
                if(!codeTxt) return;

                // 1. Buscar el c√≥digo en la nube
                const codeSnap = await db.collection('codes').where('name', '==', codeTxt).get();
                
                if(codeSnap.empty) return ui.toast("C√≥digo inv√°lido");

                const codeDoc = codeSnap.docs[0];
                const codeData = codeDoc.data();

                // 2. Verificar si ya lo us√©
                if(currentUser.redeemedCodes && currentUser.redeemedCodes.includes(codeTxt)) {
                    return ui.toast("Ya usaste este c√≥digo");
                }

                // 3. Aplicar premio (Transacci√≥n segura)
                const newXP = currentUser.xp + codeData.value;
                const newLvl = Math.floor(newXP / 100) + 1;
                
                // Actualizar mi usuario
                await myDocRef.update({
                    xp: newXP,
                    level: newLvl,
                    redeemedCodes: firebase.firestore.FieldValue.arrayUnion(codeTxt)
                });

                ui.toast(`¬°C√≥digo canjeado! Ganaste +${codeData.value} XP`);
                document.getElementById('code-input').value = "";
            }
        };

        // ================= ADMIN (Escribe en la Nube) =================
        const admin = {
            createCode: async () => {
                const name = document.getElementById('new-code-name').value.trim();
                const val = parseInt(document.getElementById('new-code-val').value);
                
                if(!name || !val) return;
                
                await db.collection('codes').add({ name: name, value: val });
                ui.toast("C√≥digo creado en la nube");
            },

            postNews: async () => {
                const title = document.getElementById('new-news-title').value;
                const body = document.getElementById('new-news-body').value;
                
                await db.collection('news').add({
                    title: title, body: body, date: Date.now()
                });
                ui.toast("Noticia publicada");
            },
            
            makeAdmin: async () => {
                const targetName = document.getElementById('new-admin-name').value.trim();
                const snap = await db.collection('users').where('username', '==', targetName).get();
                
                if(snap.empty) return ui.toast("Usuario no encontrado");
                
                snap.docs[0].ref.update({ role: 'admin' });
                ui.toast(targetName + " ahora es Admin");
            }
        };
    </script>
</body>
</html>


